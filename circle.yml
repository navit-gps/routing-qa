machine:
  environment:
    MAPCODE: 170526
    MAP: europe-netherlands

dependencies:
  pre:
    - "[ -d ~/maps ] || mkdir ~/maps"
 #   - wget -c -O ~/maps/europe-belgium.bin https://769-32646075-gh.circle-artifacts.com/0/tmp/circle-artifacts.ZNELIQ8/europe-belgium.bin
 #   - wget -c -O ~/maps/europe-france.bin https://767-32646075-gh.circle-artifacts.com/0/tmp/circle-artifacts.sJikzpP/europe-france.bin
 #   - wget -c -O ~/maps/us-west.bin https://772-32646075-gh.circle-artifacts.com/0/tmp/circle-artifacts.9SaS25u/us-west.bin
 #   - wget -c -O ~/maps/europe-netherlands.bin https://773-32646075-gh.circle-artifacts.com/0/tmp/circle-artifacts.NHqsvHm/europe-netherlands.bin
    - sudo apt-get update > /dev/null 2> /dev/null
    - sudo apt-get install cmake
    - sudo apt-get install libpng12-dev 
  #  - sudo apt-get install libgtk2.0-dev 
    - sudo apt-get install librsvg2-bin 
    - sudo apt-get install libfreetype6-dev
    - sudo apt-get install libdbus-glib-1-dev
    - sudo apt-get install g++
    - sudo pip install pyyaml
    - sudo pip install junit-xml
    - git clone https://github.com/navit-gps/navit.git
    - git checkout ${CIRCLE_BRANCH}:
        pwd: navit/
    - mkdir bin
    - cmake ../navit -Dgraphics/qt_qpainter:BOOL=FALSE -Dgui/qml:BOOL=FALSE:
        pwd: bin
    - make -j32:
        pwd: bin
    - GEOFAB=$( echo $MAP | sed -e 's@europe-@europe/@' ); wget -c -O  ~/${MAP}-latest.osm.pbf http://download.geofabrik.de/${GEOFAB}-latest.osm.pbf
  cache_directories:
    - "~/assets/"
    - ./navit/bin/navit/maptool/maptool -P  -6 -s1 -e1 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin:
        timeout: 7200
    - ./navit/bin/navit/maptool/maptool -P  -6 -s2 -e2 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s3 -e3 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s4 -e4 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s5 -e5 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s6 -e6 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin:
       timeout: 7200
    - ./navit/bin/navit/maptool/maptool -P  -6 -s7 -e7 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s8 -e8 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s9 -e9 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s10 -e10 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ./navit/bin/navit/maptool/maptool -P  -6 -s11 -i ~/${MAP}-latest.osm.pbf $CIRCLE_ARTIFACTS/${MAP}.bin
    - ls -la $CIRCLE_ARTIFACTS
test:
  post:
    - sed -i -e 's@name="Local GPS" profilename="car" enabled="yes" active="1"@name="Local GPS" profilename="car" enabled="no" active="0"@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@name="Demo" profilename="car" enabled="no" active="yes"@name="Demo" profilename="car" enabled="yes" active="yes" refresh="1"@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@type="internal" enabled@type="internal" fullscreen="1" font_size="350" enabled@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@libbinding_dbus.so" active="no"@libbinding_dbus.so" active="yes"@' navit.xml:
        pwd: bin/navit/
    - sed -i -e 's@name="Car" nightlayout="Car-dark"@name="Car"@' navit.xml:
        pwd: bin/navit/
# FIXME : maps should be defined in the yaml and managed via the python script
    - echo '<map type="binfile" data="~/maps/us-west.bin" />' > maps/us-west.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-austria.bin" />' > maps/austria.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-belgium.bin" />' > maps/belgium.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-france.bin" />' > maps/france.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-germany.bin" />' > maps/germany.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-italy.bin" />' > maps/italy.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-lithuania.bin" />' > maps/lithuania.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="$CIRCLE_ARTIFACTS/${MAP}.bin" />' > maps/netherlands.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-poland.bin" />' > maps/poland.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-spain.bin" />' > maps/spain.xml:
        pwd: bin/navit/
    - echo '<map type="binfile" data="~/maps/europe-switzerland.bin" />' > maps/switzerland.xml:
        pwd: bin/navit/
    - echo 'navit.mapset.map[@description=="Navigation"].active=1;' > gui_internal.txt:
        pwd: bin/navit/
    - ./navit:
        pwd: bin/navit/
        background: true
    - python test.py $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS "metric"
    - dbus-send  --print-reply --session --dest=org.navit_project.navit /org/navit_project/navit/default_navit org.navit_project.navit.navit.quit
    - sed -i -e 's/navit center=/navit imperial="1" center=/' navit.xml:
        pwd: bin/navit/
    - ./navit:
        pwd: bin/navit/
        background: true
    - python test.py $CIRCLE_ARTIFACTS $CIRCLE_TEST_REPORTS "imperial"
    - dbus-send  --print-reply --session --dest=org.navit_project.navit /org/navit_project/navit/default_navit org.navit_project.navit.navit.quit


